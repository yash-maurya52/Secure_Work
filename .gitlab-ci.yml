include:
  - template: Security/SAST.gitlab-ci.yml

stages:
  - security_scan
  - test  # Required for GitLab's built-in SAST jobs

variables:
  SEMGREP_RULES: "r/python.sql-injection"  # DIRECTLY targets SQLi
  SEMGREP_SEVERITY: "WARNING"              # Show all findings (even low-confidence)
  SEMGREP_NO_GIT_IGNORE: "true"            # Scan all files, even if ignored by .gitignore

scan_changed_python_files:
  stage: security_scan
  image: python:3.9-alpine
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
  before_script:
    - apk add --no-cache git
    - pip install semgrep
  script:
    - echo "üîç Scanning ALL Python files (strict mode)..."
    - semgrep --config="$SEMGREP_RULES" \
              --severity="$SEMGREP_SEVERITY" \
              --error \
              --strict \
              --no-rewrite-rule-ids \
              --sarif \
              --output=semgrep.sarif \
              .
  artifacts:
    when: always
    reports:
      sast: semgrep.sarif